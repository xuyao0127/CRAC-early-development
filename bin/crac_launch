#!/usr/bin/env python3
import sys
import os
import shutil
import subprocess

help_msg = '''
  USAGE: [srun] crac_launch [--verbose] [--timing] [DMTCP_OPTIONS ...]
                            [--use-shadowlibs] [--ckptdir DIR] MPI_EXECUTABLE [...]
          For DMTCP options, do: dmtcp_launch --help
'''

# dmtcp options that requires a value
dmtcp_options = ["-i", "--interval", "-h", "--coord-host",
                 "-p", "--coord-port", "--ckptdir",
                 "--ckpt-signal", "--with-plugin",
                 "--tmpdir", "--coord-logfile"]
verbose = False
gdb = False
shadow = False
crac_root_path = os.path.dirname(os.path.realpath(__file__)) + "/../"
tmp_lib_path = crac_root_path + "lib"
ckptdir_path = './'

# if no arguments provided, print the help message
if not sys.argv:
  print(help_msg)
  sys.exit(1)

# Find where are the target app and its arguments
index = 1
while index < len(sys.argv):
  if sys.argv[index] in dmtcp_options:
    index = index + 2
  elif sys.argv[index][0] == '-':
    index = index + 1
  else:
    break;
dmtcp_flags = sys.argv[1:index]
target_app = sys.argv[index:]

# Get the absolute path of the target app
tmp = target_app[0]
target_app[0] = shutil.which(target_app[0])
if not target_app[0]:
  print("Executable " + tmp + " not found.")
  sys.exit(1)

# Special arguments
if "--use-shadowlibs" in dmtcp_flags:
  shadow = True
  dmtcp_flags.remove("--use-shadowlibs")

if "--gdb" in dmtcp_flags:
  gdb = True
  dmtcp_flags.remove("--gdb")
if "--help" in dmtcp_flags:
  print(help_msg)
  sys.exit(1)
if "--verbose" in dmtcp_flags:
  verbose = True
  dmtcp_flags.remove("--verbose")
if "--timing" in dmtcp_flags:
  os.environ["MANA_TIMING"] = "1"
  dmtcp_flags.remove("--timing")
if "srun" in target_app or "sbatch" in target_app:
  print(help_msg)
  sys.exit(1)
if "--ckptdir" in dmtcp_flags:
  ckptdir_path = dmtcp_flags[dmtcp_flags.index("--ckptdir") + 1]
  if not os.path.exists(ckptdir_path):
    print("crac_launch: --ckptdir " + ckptdir_path + ": Checkpoint directory doesn't exist")
    sys.exit(1)
if "--quiet" in dmtcp_flags or "-q" in dmtcp_flags:
  os.environ["MANA_QUIET"] = "1"
  if "--quiet" in dmtcp_flags:
    dmtcp_flags.remove("--quiet")
  else:
    dmtcp_flags.remove("-q")

# Check if an old checkpoint file exists in the ckptdir
for entry in os.scandir(ckptdir_path):
  if entry.is_dir() and entry.name.find("ckpt_rank_") != -1:
    print("Old checkpoint files detected in the given checkpoint directory.")
    print("  " + os.path.abspath(ckptdir_path) + "/ckpt_rank_*")
    print("Please move or delete the old checkpoint files before a new run.")
    sys.exit(1)

# Find the .crac.rc file to get the hostname and port of the coordinator
rc_filename = ""
host_flag = ""
port_flag = ""
if "SLURM_JOB_ID" in os.environ:
  rc_filename = os.path.expanduser("~/.crac-slurm-" + os.environ["SLURM_JOB_ID"] + ".rc")
else:
  rc_filename = os.path.expanduser("~/.crac.rc")
rc_file = open(rc_filename)
for line in rc_file:
  line = line.split()
  if not line:
    break
  if line[0] == "Host:":
    host_flag = " -h " + line[1] + " "
  elif line[0] == "Port:":
    port_flag = " -p " + line[1] + " "
rc_file.close()

# Remove old ~/.crac_*.rc files from a week ago or more.
os.system("find $HOME/.crac*.rc -ignore_readdir_race -maxdepth 0 -mtime +7 -type f -delete")

# Check dmtcp coordinator
coordinator_found = os.system(crac_root_path + "bin/dmtcp_command -s " + host_flag + port_flag + " &>/dev/null")
if coordinator_found != 0:
  print("No MANA coordinator detected. Try:")
  print("  " + crac_root_path + "bin/dmtcp_coordinator")
  print("Or:")
  print("  " + crac_root_path + "bin/dmtcp_coordinator --exit-on-last -q --daemon")
  sys.exit(1)

# Build the command line to be executed
if not verbose:
  dmtcp_flags.insert(0, "-q -q")
if gdb:
  cmd_line = shutil.which("gdb") + " --args "
else:
  cmd_line = ""
cmd_line += crac_root_path + "bin/dmtcp_launch " + host_flag + port_flag + \
            " --no-gzip --join-coordinator --disable-dl-plugin" + \
            " --with-plugin " + crac_root_path + "lib/dmtcp/libcrac.so " + \
            " ".join(dmtcp_flags) + " " + crac_root_path + "bin/lower-half " + \
            " " .join(target_app)
if verbose:
  print(cmd_line)

# This is for debug only
cmd_line = "/usr/bin/echo " + cmd_line
os.execv(cmd_line.split()[0], cmd_line.split())
